<!--
    Copyright (c) 2022, 2023, Oracle and/or its affiliates. All rights reserved.
    ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
-->
<!DOCTYPE html>
<html>
    <head>
        <title>Build Report - Oracle GraalVM Native Image</title>
<style>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

:root {
    --color-graalvm-dark-green: #003c4a;
    --color-graalvm-green: #00758f;
    --color-graalvm-orange: #f29110;
    --color-graalvm-red: #c74836;
}

body {
    max-width: 1500px;
    width: 90%;
    margin: 10px auto;
    font-family: verdana, arial, sans-serif;
    font-size: 16px;
    font-weight: 400;
    line-height: 1.5;
    color: black;
    background-color: white;
}

header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
}

h2, h3, h4, h5 {
	margin: 0;
	font-weight: 500;
}

h2 {
	font-size: 32px;
}

h3 {
	font-size: 28px;
}

h4 {
	font-size: 24px;
}

h5 {
	font-size: 20px;
}

a, 
a:hover {
    color: var(--color-graalvm-dark-green);
}

.header-title {
    color: var(--color-graalvm-dark-green);
    font-weight: 600;
}

.header-image-name {
    color: var(--color-graalvm-green);
}

.tabs {
    display: flex;
	border-bottom: 1px solid lightgray;
    padding-left: 0;
    list-style: none;
}

.tab-link {
    display: block;
	margin-bottom: -1px;
	border: 1px solid transparent;
    border-radius: 7px 7px 0 0;
	padding: 10px 15px;
	color: black;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
    cursor: pointer;
	transition: border-color .1s;
}

.tab-link:hover {
	border-color: lightgray;
}

.tab-link.active {
	border-color: lightgray lightgray white;
}

.tab-content {
    display: none;
    transition: opacity .1s;
}

.tab-content.active {
    display: block;
}

.section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
}

.section-title div h4 {
    display: inline;
}

.section-selects {
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.section-selects select {
    display: inline-block;
	width: 250px;
    border: 1px solid lightgray;
	border-radius: 7px;
	padding: 10px;
    font-family: inherit;
    font-weight: inherit;
    font-size: inherit;
    line-height: inherit;
    color: inherit;
    background-color: inherit;
    cursor: pointer;
}

.section-containers {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: center;
    margin: 0;
}

.loader {
    border: 4px solid white;
    border-top: 4px solid black;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin .75s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.tooltip {
    position: relative;
    display: inline-block;
    margin: 0 10px;
}

.tooltip::before {
    content: "\24D8";
    font-size: 18px;
    font-weight: 600;
}

.tooltip > .tooltip-container {
    visibility: hidden;
    position: absolute;
    z-index: 1;
    top: 120%;
    left: 50%;
    width: 400px;
    margin-left: -215px;
    border-radius: 7px;
    padding: 10px 15px;
    color: white;
    background-color: black;
    transition: opacity .1s;
}

.tooltip > .tooltip-container::after {
    content: "";
    position: absolute;
    bottom: 100%;
    left: 50%;
    margin-left: -5px;
    border: 5px solid;
    border-color: transparent transparent black transparent;
}

.tooltip:hover > .tooltip-container {
    visibility: visible;
    opacity: 1;
}

table {
	width: 100%;
	margin-bottom: 20px;
    border-collapse: collapse;
}

table > thead {
    text-align: left;
}

table > thead > tr > th,
table > tbody > tr > td {
	padding: 10px 0;
    border-bottom: 1px solid lightgray;
}

.package-list-root {
    text-align: right;
}

.package-list-root > h4 {
    font-weight: 600 !important;
}

.package-list-package-name {
    min-width: 500px;
    max-width: 600px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

.heap-item-name {
    max-width: 500px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

.heap-item-size {
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-width: 350px;
}

.heap-item-size > meter {
    width: 70%;
}

/* For Firefox */
meter {
    border-radius: 30px;
}
meter:-moz-meter-optimum::-moz-meter-bar {
    background: var(--color-graalvm-dark-green);
}
meter:-moz-meter-sub-optimum::-moz-meter-bar {
    background: var(--color-graalvm-orange);
}
meter:-moz-meter-sub-sub-optimum::-moz-meter-bar {
    background: var(--color-graalvm-red);
}

/* For Chrome */
meter::-webkit-meter-bar {
    background: lightgray;
}
meter::-webkit-meter-optimum-value {
    background: var(--color-graalvm-dark-green);
}
meter::-webkit-meter-suboptimum-value {
    background: var(--color-graalvm-orange);
}
meter::-webkit-meter-even-less-good-value {
    background: var(--color-graalvm-red);
}

.sbom-item-artifact {
    font-weight: bold;
}

.version {
    border-radius: 10px;
    padding: 5px 10px;
    color: white;
    background-color: var(--color-graalvm-green);
    font-weight: 600;
    font-size: 14px;
}

.download {
    border: 0;
    border-radius: 10px;
    padding: 12px;
    color: white;
    background-color: var(--color-graalvm-orange);
    font-weight: 600;
    cursor: pointer;
    float: right;
}

/* Plotly.js customizations */
g.hovertext > path {
    opacity: 0.8;
}
</style>
    </head>
    <body>
        <header>
            <h2 class="header-title">Build Report - <span id="image-name" class="header-image-name"></span></h2>
        </header>
        <nav>
            <ul class="tabs">
                <li><button class="tab-link active" data-target="#summary-tab">Summary</button></li>
                <li><button class="tab-link" data-target="#code-area-tab">Code Area</button></li>
                <li><button class="tab-link" data-target="#image-heap-tab">Image Heap</button></li>
                <li><button class="tab-link" data-target="#sbom-tab">Software Bill of Materials (SBOM)</button></li>
            </ul>
        </nav>
        <section id="summary-tab" class="tab-content active">
            <div>
                <button id="build-output-download" class="download">Download as JSON</button>
                <table>
                    <thead>
                        <tr>
                            <th colspan="2"><h4>Environment</h4></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-java-version-info" target="_blank">Java Version</a></td>
                            <td id="build-output-environment-java-version">Loading...</td>
                        </tr>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-version-info" target="_blank">Vendor Version</a></td>
                            <td id="build-output-environment-vendor-version">Loading...</td>
                        </tr>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-graal-compiler" target="_blank">Graal Compiler</a></td>
                            <td>
                                Optimization level: <span id="build-output-environment-graal-compiler-optimization-level">Loading...</span>,
                                Target machine: <span id="build-output-environment-graal-compiler-march">Loading...</span>,
                                <a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#recommendation-pgo" target="_blank">PGO</a>: <span id="build-output-environment-graal-compiler-pgo">Loading...</span>
                            </td>
                        </tr>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-ccompiler" target="_blank">C Compiler</a></td>
                            <td id="build-output-environment-c-compiler">Loading...</td>
                        </tr>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-gc" target="_blank">Garbage Collector</a></td>
                            <td id="build-output-environment-garbage-collector">Loading...</td>
                        </tr>
                    </tbody>
                </table>
                <table>
                    <thead>
                        <tr>
                            <th colspan="7"><h4>Analysis Results</h4></th>
                        </tr>
                        <tr style="text-align: right;">
                            <th style="text-align: left;">Category</th>
                            <th>Types</th>
                            <th>in %</th>
                            <th>Fields</th>
                            <th>in %</th>
                            <th>Methods</th>
                            <th>in %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="text-align: right;">
                            <td style="text-align: left;"><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-reachability" target="_blank">Reachable</a></td>
                            <td id="build-output-analysis-results-reachable-types-count">Loading...</td>
                            <td id="build-output-analysis-results-reachable-types-percentage">Loading...</td>
                            <td id="build-output-analysis-results-reachable-fields-count">Loading...</td>
                            <td id="build-output-analysis-results-reachable-fields-percentage">Loading...</td>
                            <td id="build-output-analysis-results-reachable-methods-count">Loading...</td>
                            <td id="build-output-analysis-results-reachable-methods-percentage">Loading...</td>
                        </tr>
                        <tr style="text-align: right;">
                            <td style="text-align: left;"><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-reflection-registrations" target="_blank">Reflection</a></td>
                            <td id="build-output-analysis-results-reflection-types-count">Loading...</td>
                            <td id="build-output-analysis-results-reflection-types-percentage">Loading...</td>
                            <td id="build-output-analysis-results-reflection-fields-count">Loading...</td>
                            <td id="build-output-analysis-results-reflection-fields-percentage">Loading...</td>
                            <td id="build-output-analysis-results-reflection-methods-count">Loading...</td>
                            <td id="build-output-analysis-results-reflection-methods-percentage">Loading...</td>
                        </tr>
                        <tr style="text-align: right;">
                            <td style="text-align: left;"><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-jni-access-registrations" target="_blank">JNI</a></td>
                            <td id="build-output-analysis-results-jni-types-count">Loading...</td>
                            <td id="build-output-analysis-results-jni-types-percentage">Loading...</td>
                            <td id="build-output-analysis-results-jni-fields-count">Loading...</td>
                            <td id="build-output-analysis-results-jni-fields-percentage">Loading...</td>
                            <td id="build-output-analysis-results-jni-methods-count">Loading...</td>
                            <td id="build-output-analysis-results-jni-methods-percentage">Loading...</td>
                        </tr>
                        <tr style="text-align: right;">
                            <td style="text-align: left;"><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-reachability" target="_blank">Loaded</a></td>
                            <td id="build-output-analysis-results-total-types-count">Loading...</td>
                            <td>100.000%</td>
                            <td id="build-output-analysis-results-total-fields-count">Loading...</td>
                            <td>100.000%</td>
                            <td id="build-output-analysis-results-total-methods-count">Loading...</td>
                            <td>100.000%</td>
                        </tr>
                    </tbody>
                </table>
                <div class="section-containers">
                    <div id="build-output-image-details"><div class="loader"></div>&emsp;<h5>Loading...</h5></div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th colspan="2"><h4>Resource Usage</h4></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total build time</td>
                            <td id="build-output-resource-usage-total-secs"></td>
                        </tr>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-garbage-collections" target="_blank">Garbage collection</a></td>
                            <td id="build-output-resource-usage-gc"></td>
                        </tr>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-peak-rss" target="_blank">Peak RSS</a></td>
                            <td id="build-output-resource-usage-peak-rss"></td>
                        </tr>
                        <tr>
                            <td><a href="https://www.graalvm.org/latest/reference-manual/native-image/overview/BuildOutput/#glossary-cpu-load" target="_blank">CPU load</a></td>
                            <td id="build-output-resource-usage-cpu-load"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section id="code-area-tab" class="tab-content">
            <div>
                <div class="section-title">
                    <div>
                        <h4>Method-based code area breakdown</h4>
                        <div class="tooltip">
                            <div class="tooltip-container">
                                The chart bellow shows how different packages <i>relate</i> to each other in terms of their <b>bytecode size</b> or a total <b>number</b> of their methods.<br /><br />
                                <i>Note: Shown packages contain only the methods from hosted universe found as <b>reachable</b>. Also, a fixed threshold (0.1% of total percentage) is used to <i>limit</i> the amount of data shown on the chart.</i>
                            </div>
                        </div>
                    </div>
                    <div class="section-selects">
                        <select id="method-breakdown-type">
                            <option disabled>Breakdown type</option>
                            <option value="bytecodeSize" selected>By bytecode size</option>
                            <option value="count">By count</option>
                        </select>
                        <div class="tooltip">
                            <div class="tooltip-container">
                                Breakdown type represents a <b>metric</b> used for calculating every package percentage. Available metrics are:  method <b>bytecode size</b>, and method <b>count</b>.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-containers">
                    <div id="method-breakdown"><div class="loader"></div>&emsp;<h5>Loading...</h5></div>
                </div>
            </div>
            <div>
                <table id="package-class-list">
                    <thead>
                        <tr>
                            <th colspan="3"><h4>Packages and classes</h4></th>
                        </tr>
                        <tr>
                            <th class="package-list-package-name">Name</th>
                            <th id="package-list-value-kind" style="text-align: right;"></th>
                            <th style="text-align: right;">Percentage</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <section id="image-heap-tab" class="tab-content">
            <table>
                <thead>
                    <tr>
                        <th class="heap-item-name">Object types</th>
                        <th class="heap-item-size">Size<span><span id="heap-breakdown-total-size"></span> in total</span></th>
                    </tr>
                </thead>
                <tbody id="heap-breakdown"></tbody>
            </table>
        </section>
        <section id="sbom-tab" class="tab-content">
            <button id="sbom-download" class="download">Download as JSON</button>
            <table>
                <thead>
                    <tr>
                        <th>Organization</th>
                        <th>Artifact</th>
                        <th>Version</th>
                    </tr>
                </thead>
                <tbody id="sbom-list"></tbody>
            </table>
        </section>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

class BuildOutput {
    constructor() {}

    // class fields are not well supported by Closure: https://github.com/google/closure-compiler/issues/2731

    static getInstance() {
        if (!this._instance) {
            this._instance = new BuildOutput();
        }
        return this._instance;
    }

    getData() {
        return this._data;
    }

    setData(data) {
        this._data = data;
    }

    render(detailsContainer) {
        this.renderEnvironment();
        this.renderAnalysisResults();
        this.renderImageDetails(detailsContainer);
        this.renderResourceUsage();
    };

    renderEnvironment() {
        for (const key of ['java_version', 'vendor_version', 'c_compiler', 'garbage_collector']) {
            const elem = document.getElementById(`build-output-environment-${key.replace('_', '-')}`);
            elem.innerHTML = key.includes('version') ? `<span class="version">${this._data.general_info[key]}</span>` : this._data.general_info[key];
        }

        const graalCompiler = this._data.general_info.graal_compiler
        document.getElementById('build-output-environment-graal-compiler-optimization-level').innerText = graalCompiler.optimization_level
        document.getElementById('build-output-environment-graal-compiler-march').innerText = graalCompiler.march
        document.getElementById('build-output-environment-graal-compiler-pgo').innerText = graalCompiler.pgo;
    };

    renderAnalysisResults() {
        const analysisResults = this._data.analysis_results;
        const totalTypes = analysisResults.classes.total;
        const totalFields = analysisResults.fields.total;
        const totalMethods = analysisResults.methods.total;
        document.getElementById('build-output-analysis-results-total-types-count').innerText = totalTypes
        document.getElementById('build-output-analysis-results-total-fields-count').innerText = totalFields
        document.getElementById('build-output-analysis-results-total-methods-count').innerText = totalMethods

        for (const key of ['reachable', 'reflection', 'jni']) {
            const typesCountElem = document.getElementById(`build-output-analysis-results-${key}-types-count`);
            typesCountElem.innerText = Utils.printIfExists(analysisResults.classes[key]);
            const typesPercentageElem = document.getElementById(`build-output-analysis-results-${key}-types-percentage`);
            typesPercentageElem.innerText = Utils.printIfExists(analysisResults.classes[key], Utils.toPercentage(analysisResults.classes[key] / totalTypes));

            const fieldCountElem = document.getElementById(`build-output-analysis-results-${key}-fields-count`);
            fieldCountElem.innerText = Utils.printIfExists(analysisResults.fields[key]);
            const fieldsPercentageElem = document.getElementById(`build-output-analysis-results-${key}-fields-percentage`);
            fieldsPercentageElem.innerText = Utils.printIfExists(analysisResults.fields[key], Utils.toPercentage(analysisResults.fields[key] / totalFields));

            const methodsCountElem = document.getElementById(`build-output-analysis-results-${key}-methods-count`);
            methodsCountElem.innerText = Utils.printIfExists(analysisResults.methods[key]);
            const methodsPercentageElem = document.getElementById(`build-output-analysis-results-${key}-methods-percentage`);
            methodsPercentageElem.innerText = Utils.printIfExists(analysisResults.methods[key], Utils.toPercentage(analysisResults.methods[key] / totalMethods));
        }
    };

    renderImageDetails(container) {
        const details = this._data.image_details;
        const data = [];

        data.push({
            label: "Code area",
            value: details.code_area.bytes,
            details: `${details.code_area.compilation_units} compilation units`,
            target: "#code-area-tab"
        });

        data.push({
            label: "Image heap",
            value: details.image_heap.bytes,
            details: `${Utils.toHumanReadableSize(details.image_heap.resources.bytes)} for ${details.image_heap.resources.count} resources`,
            target: "#image-heap-tab"
        });

        let debugInfoBytes = 0;
        if (details.debug_info) {
            debugInfoBytes = details.debug_info.bytes;
            data.push({
                label: "Debug info",
                value: debugInfoBytes
            });
        }

        const otherBytes = details.total_bytes - details.code_area.bytes - details.image_heap.bytes - debugInfoBytes;
        data.push({
            label: "Other data",
            value: otherBytes
        });

        const chart = new HorizontalStackedBar(document.body.clientWidth, 200, "Image Details", details.total_bytes, data, container);
        chart.draw();
    };

    renderResourceUsage() {
        const resourceUsage = this._data.resource_usage;

        const totalSecsElem = document.getElementById('build-output-resource-usage-total-secs');
        totalSecsElem.innerText = `${resourceUsage.total_secs.toFixed(2)}s`;

        const gcElem = document.getElementById('build-output-resource-usage-gc');
        gcElem.innerText = `${resourceUsage.garbage_collection.total_secs.toFixed(2)}s in ${resourceUsage.garbage_collection.count} GCs`

        const peakRssElem = document.getElementById('build-output-resource-usage-peak-rss');
        peakRssElem.innerText = `${Utils.toHumanReadableSize(resourceUsage.memory.peak_rss_bytes)} (${Utils.toPercentage(resourceUsage.memory.peak_rss_bytes / resourceUsage.memory.system_total)} of ${Utils.toHumanReadableSize(resourceUsage.memory.system_total)} system memory)`

        const cpuLoadElem = document.getElementById('build-output-resource-usage-cpu-load');
        cpuLoadElem.innerText = `${resourceUsage.cpu.load.toFixed(3)} (${Utils.toPercentage(resourceUsage.cpu.load / resourceUsage.cpu.total_cores)} of ${resourceUsage.cpu.total_cores} cores)`
    };
}
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

class MethodBreakdown {
    constructor() {}

    // class fields are not well supported by Closure: https://github.com/google/closure-compiler/issues/2731

    static getInstance() {
        if (!this._instance) {
            this._instance = new MethodBreakdown();
        }
        return this._instance;
    }

    setCountData(countData) {
        this._countData = countData;
    }

    setBytecodeSizeData(bytecodeSizeData) {
        this._bytecodeSizeData = bytecodeSizeData;
    }

    static _limitData(data, threshold) {
        if (threshold == 0) {
            return data;
        }

        const limitedData = { label: data.label, value: data.value, ratio: data.ratio, height: data.height, children: [], depth: data.depth, parent: data.parent };
        for (const child of data.children) {
            if (child.ratio >= threshold) {
                limitedData.children.push(child);
                MethodBreakdown._limitData(child, threshold);
            }
        }

        return limitedData;
    }

    _renderChart(type, origin, threshold, breakdownContainer, listContainer) {
        let data;
        let valueKind;
        switch (type) {
            case MethodBreakdown.Type.count:
                data = MethodBreakdown._limitData(this._countData[origin], threshold);
                valueKind = Sunburst.ValueKind.count;
                break;
            case MethodBreakdown.Type.bytecodeSize:
                data = MethodBreakdown._limitData(this._bytecodeSizeData[origin], threshold);
                valueKind = Sunburst.ValueKind.bytecodeSize;
                break;
        }

        const chart = new Sunburst(document.body.clientWidth, 675, data, valueKind, breakdownContainer, (data, type) => this._updateTable(data, type, listContainer));
        chart.draw();
    }

    _renderTable(type, origin, container) {
        let data;
        switch (type) {
            case MethodBreakdown.Type.count:
                data = this._countData[origin];
                break;
            case MethodBreakdown.Type.bytecodeSize:
                data = this._bytecodeSizeData[origin];
                break;
        }
        this._updateTable(data, type, container);
    }

    _updateTable(data, type, container) {
        const tableElement = document.getElementById(container);

        const valueKindElement = tableElement.querySelector("#package-list-value-kind");
        switch (type) {
            case MethodBreakdown.Type.count:
                valueKindElement.textContent = "Method count";
                break;
            case MethodBreakdown.Type.bytecodeSize:
                valueKindElement.textContent = "Bytecode size";
                break;
        }

        const tableBodyElement = tableElement.querySelector("tbody");
        tableBodyElement.innerHTML = "";

        const childrenData = data.children.sort((a, b) => b.ratio - a.ratio);
        for (const childData of childrenData) {
            const nameElement = document.createElement("td");
            nameElement.classList.add("package-name");
            let childName = childData.label;
            let parentData = childData.parent;
            while (parentData != null && parentData.parent != null) {
                childName = parentData.label + "." + childName;
                parentData = parentData.parent;
            }
            nameElement.textContent = childName;

            const valueElement = document.createElement("td");
            valueElement.style.textAlign = "right";
            valueElement.textContent = (type == MethodBreakdown.Type.bytecodeSize) ? Utils.toHumanReadableSize(childData.value) : childData.value;

            const percentageElement = document.createElement("td");
            percentageElement.style.textAlign = "right";
            percentageElement.textContent = Utils.toPercentage(childData.ratio / data.ratio, 3);

            const rowElement = document.createElement("tr");
            rowElement.appendChild(nameElement);
            rowElement.appendChild(valueElement);
            rowElement.appendChild(percentageElement);

            tableBodyElement.appendChild(rowElement);
        }
    }

    render(type, breakdownContainer, listContainer) {
        const origin = "reachable";
        const threshold = 0.001;
        this._renderChart(type, origin, threshold, breakdownContainer, listContainer);
        this._renderTable(type, origin, listContainer);
    }
}

MethodBreakdown.Type = {
    count: "count",
    bytecodeSize: "bytecodeSize"
};

MethodBreakdown.dataWorker = () => {
    const Origin = {
        reachable: "reachable",
    };

    const createTypesMap = (types) => {
        const typeMap = {};
        for (const type of types) {
            const typeData = {
                name: type.name,
                parts: type.name.split(".")
            };
            typeMap[type.id] = typeData;
        }
        return typeMap;
    };

    const getDataByOrigin = (data, method) => {
        const array = [];
        switch (method.origin) {
            case Origin.reachable: {
                array.push({
                    count: data.count.reachable,
                    bytecodeSize: data.bytecodeSize.reachable
                });
                break;
            }
        }

        return array;
    };

    const calculateRatio = (data) => {
        const ratio = (data, total) => {
            if (total == null) {
                total = data.value;
                data.ratio = 1;
            }
            for (const child of data.children) {
                child.ratio = child.value / total;
                ratio(child, total);
            }
        };
        ratio(data, null);
    }

    const calculateHeight = (data) => {
        if (data.children.length == 0) {
            data.height = 0;
        } else {
            let maxChildHeight = 0;
            for (const child of data.children) {
                const childHeight = calculateHeight(child);
                maxChildHeight = Math.max(childHeight, maxChildHeight);
            }
            data.height = maxChildHeight + 1;
        }

        return data.height;
    }

    this.onmessage = (e) => {
        const typesMap = createTypesMap(e.data.types);

        const countData = {
            reachable: { label: "Total", value: 0, children: [], depth: 0, parent: null },
        };
        const bytecodeSizeData = {
            reachable: { label: "Total", value: 0, children: [], depth: 0, parent: null },
        };
        const allData = {
            count: countData,
            bytecodeSize: bytecodeSizeData
        }
        for (const method of e.data.methods) {
            const originDataArray = getDataByOrigin(allData, method);
            for (const originData of originDataArray) {
                const declaringClassType = typesMap[method.declaringClass];

                originData.count.value += 1;
                originData.bytecodeSize.value += method.bytecodeSize;

                let children = {
                    count: originData.count.children,
                    bytecodeSize: originData.bytecodeSize.children,
                }
                let parent = {
                    count: originData.count,
                    bytecodeSize: originData.bytecodeSize,
                }
                let depth = 1;
                for (const part of declaringClassType.parts) {
                    let countChild = null;
                    for (const child of children.count) {
                        if (child.label == part) {
                            countChild = child;
                            break;
                        }
                    }
                    if (countChild == null) {
                        countChild = { label: part, value: 0, children: [], depth: depth, parent: parent.count };
                        children.count.push(countChild);
                    }
                    countChild.value += 1;

                    let bytecodeSizeChild = null;
                    for (const child of children.bytecodeSize) {
                        if (child.label == part) {
                            bytecodeSizeChild = child;
                            break;
                        }
                    }
                    if (bytecodeSizeChild == null) {
                        bytecodeSizeChild = { label: part, value: 0, children: [], depth: depth, parent: parent.bytecodeSize };
                        children.bytecodeSize.push(bytecodeSizeChild);
                    }
                    bytecodeSizeChild.value += method.bytecodeSize;

                    children = {
                        count: countChild.children,
                        bytecodeSize: bytecodeSizeChild.children
                    };
                    parent = {
                        count: countChild,
                        bytecodeSize: bytecodeSizeChild
                    };
                    depth++;
                }
            }
        }

        for (const origin in countData) {
            calculateRatio(countData[origin]);
            calculateHeight(countData[origin]);
        }

        for (const origin in bytecodeSizeData) {
            calculateRatio(bytecodeSizeData[origin]);
            calculateHeight(bytecodeSizeData[origin]);
        }

        postMessage({
            countData: countData,
            bytecodeSizeData: bytecodeSizeData
        });
    };
};
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

class SBOMList {
    constructor() {}

    // class fields are not well supported by Closure: https://github.com/google/closure-compiler/issues/2731

    static getInstance() {
        if (!this._instance) {
            this._instance = new SBOMList();
        }
        return this._instance;
    }

    getData() {
        return this._data;
    }

    setData(data) {
        this._data = data;
    }

    render(container) {
        const table = document.getElementById(container);
        table.innerHTML = "";
        const components = this._data.components;

        for (let i in components) {
            const component = components[i];
            const html =
                `<tr>
                    <td>${component.group}</td>
                    <td class="sbom-item-artifact">${component.name}</td>
                    <td><span class="version">${component.version}</span></td>
                </tr>`;

            const template = document.createElement("template");
            template.innerHTML = html;
            table.appendChild(template.content.firstChild);
        }
    }
}
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

const tabsInitializer = () => {
    const tabLinks = document.querySelectorAll(".tab-link");
    for (let i = 0; i < tabLinks.length; i++) {
        tabLinks[i].onclick = function(e) {
            for (i = 0; i < tabLinks.length; i++) {
                tabLinks[i].classList.remove("active");
            }
            e.target.classList.add("active");

            const tabs = document.querySelectorAll(".tab-content");
            for (i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            const selectedTab = document.querySelector(e.target.dataset.target);
            selectedTab.classList.add("active");
        };
    }
};

const activateTab = (target) => {
    const tabLinks = document.querySelectorAll(".tab-link");
    for (let i = 0; i < tabLinks.length; i++) {
        tabLinks[i].classList.remove("active");
    }
    const activatedTabLink = document.querySelector(`.tab-link[data-target="${target}"]`);
    activatedTabLink.classList.add("active");
    window.scrollTo({
        top: 0,
        left: 0,
        behavior: 'smooth'
    });

    const tabs = document.querySelectorAll(".tab-content");
    for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove("active");
    }
    const activatedTab = document.querySelector(target);
    activatedTab.classList.add("active");
};

window.addEventListener("load", tabsInitializer);
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */
class HorizontalStackedBar {

    // class fields are not well supported by Closure: https://github.com/google/closure-compiler/issues/2731

    constructor(width, height, title, total, data, container) {
        this._width = width;
        this._height = height;
        this._total = total;
        this._data = data;
        this._container = container;

        this._title = {
            start: {
                x: 0,
                y: 0
            },
            width: width,
            height: 0.35 * height,
            text: title,
            total: total
        };
        this._padding = {
            bottom: 0.05 * this._height
        };
        this._chart = {
            start: {
                x: 0,
                y: this._title.height
            },
            width: width,
            height: height - this._title.height - this._padding.bottom,
        };
        this._tooltip = {
            width: 200,
            height: 100,
            elements: {
                root: `${this._container}-tooltip`,
                container: `${this._container}-tooltip-container`,
                label: `${this._container}-tooltip-label`,
                value: `${this._container}-tooltip-value`,
                percentage: `${this._container}-tooltip-percentage`,
                details: `${this._container}-tooltip-details`
            }
        };
        this._tooltip.offset = {
            left: {
                x: -100 - this._tooltip.width,
                y: 20 - this._tooltip.height / 2
            },
            right: {
                x: 100,
                y: 20 - this._tooltip.height / 2
            }
        };
    }

    static _setElementStyle(element, style) {
        for (const rule in style) {
            element.style[rule] = style[rule];
        }
    }

    _drawTitle() {
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        HorizontalStackedBar._setElementStyle(rect, HorizontalStackedBar.Style.Title.Rect);
        rect.setAttribute("x", this._title.start.x);
        rect.setAttribute("y", this._title.start.y);
        rect.setAttribute("width", this._title.width);
        rect.setAttribute("height", this._title.height);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        HorizontalStackedBar._setElementStyle(text, HorizontalStackedBar.Style.Title.Text);
        text.setAttribute("x", 0);
        text.setAttribute("y", 0.5 * this._title.height);

        const labelTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        labelTSpan.textContent = this._title.text;
        text.appendChild(labelTSpan);

        const totalTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        HorizontalStackedBar._setElementStyle(totalTSpan, { textAnchor: "end" });
        totalTSpan.setAttribute("x", this._title.start.x + this._title.width);

        totalTSpan.textContent = `${Utils.toHumanReadableSize(this._title.total)} in total`;
        text.appendChild(totalTSpan);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.appendChild(rect);
        g.appendChild(text);

        return g;
    }

    _drawBar(data, offset) {
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        const ratio = data.value / this._total;
        if (ratio == 0) {
            return g;
        }

        const bar = {
            start: {
                x: this._chart.start.x + offset * this._chart.width,
                y: this._chart.start.y
            },
            width: ratio * this._chart.width,
            height: this._chart.height
        };
        bar.center = {
            x: bar.start.x + bar.width / 2,
            y: bar.start.y + bar.height / 2
        };

        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        HorizontalStackedBar._setElementStyle(rect, HorizontalStackedBar.Style.Bar.Rect(ratio));
        rect.setAttribute("width", bar.width);
        rect.setAttribute("height", bar.height);
        rect.setAttribute("x", bar.start.x);
        rect.setAttribute("y", bar.start.y);
        rect.setAttribute("rx", ".75%");

        const labelTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        labelTSpan.setAttribute("dy", "-5%");
        labelTSpan.textContent = data.label;

        const sublabelTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        sublabelTSpan.setAttribute("x", 0);
        sublabelTSpan.setAttribute("dy", "15%");
        sublabelTSpan.textContent = `${Utils.toHumanReadableSize(data.value)} (${Utils.toPercentage(ratio, 1)})`;

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        HorizontalStackedBar._setElementStyle(text, HorizontalStackedBar.Style.Bar.Text);
        text.setAttribute("transform", `translate(${bar.center.x}, ${bar.center.y}) scale(${ratio > 0.1 ? 1 : 0.55}) rotate(${ratio > 0.1 ? 0 : -90})`);
        text.appendChild(labelTSpan);
        text.appendChild(sublabelTSpan);

        g.appendChild(rect);
        g.appendChild(text);
        g.addEventListener("mouseenter", function() {
            this._showTooltip(bar.center, data, offset <= 0.5 ? "right" : "left");
        }.bind(this));
        g.addEventListener("mouseleave", function() {
            this._hideTooltip();
        }.bind(this));

        if ("target" in data) {
            g.style.cursor = "pointer";
            g.addEventListener("click", function() {
                activateTab(data.target);
            });
        } else {
            g.style.cursor = "not-allowed";
            g.style.opacity = 0.6;
        }

        return g;
    }

    _drawTooltip() {
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        HorizontalStackedBar._setElementStyle(rect, HorizontalStackedBar.Style.Tooltip.Rect);
        rect.setAttribute("id", this._tooltip.elements.container);
        rect.setAttribute("width", this._tooltip.width);
        rect.setAttribute("height", this._tooltip.height);

        const labelTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        HorizontalStackedBar._setElementStyle(labelTSpan, HorizontalStackedBar.Style.Tooltip.Label);
        labelTSpan.setAttribute("id", this._tooltip.elements.label);
        labelTSpan.setAttribute("dx", this._tooltip.width / 2);
        labelTSpan.setAttribute("dy", 0.2 * this._tooltip.height);

        const valueTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        HorizontalStackedBar._setElementStyle(valueTSpan, HorizontalStackedBar.Style.Tooltip.Content);
        valueTSpan.setAttribute("id", this._tooltip.elements.value);
        valueTSpan.setAttribute("dx", this._tooltip.width / 2);
        valueTSpan.setAttribute("dy", 0.45 * this._tooltip.height);

        const percentageTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        HorizontalStackedBar._setElementStyle(percentageTSpan, HorizontalStackedBar.Style.Tooltip.Content);
        percentageTSpan.setAttribute("id", this._tooltip.elements.percentage);
        percentageTSpan.setAttribute("dx", this._tooltip.width / 2);
        percentageTSpan.setAttribute("dy", 0.65 * this._tooltip.height);

        const detailsTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        HorizontalStackedBar._setElementStyle(detailsTSpan, HorizontalStackedBar.Style.Tooltip.Content);
        detailsTSpan.setAttribute("id", this._tooltip.elements.details);
        detailsTSpan.setAttribute("dx", this._tooltip.width / 2);
        detailsTSpan.setAttribute("dy", 0.85 * this._tooltip.height);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        HorizontalStackedBar._setElementStyle(text, HorizontalStackedBar.Style.Tooltip.Text);
        text.appendChild(labelTSpan);
        text.appendChild(valueTSpan);
        text.appendChild(percentageTSpan);
        text.appendChild(detailsTSpan);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        HorizontalStackedBar._setElementStyle(g, HorizontalStackedBar.Style.Tooltip.Container);
        g.setAttribute("id", this._tooltip.elements.root);
        g.appendChild(rect);
        g.appendChild(text);

        return g;
    }

    _showTooltip(center, data, orientation) {
        const start = {
            x: center.x + this._tooltip.offset[orientation].x,
            y: center.y + this._tooltip.offset[orientation].y
        }

        const container = document.getElementById(this._tooltip.elements.container);
        container.setAttribute("x", start.x);
        container.setAttribute("y", start.y);

        const labelTSpan = document.getElementById(this._tooltip.elements.label);
        labelTSpan.setAttribute("x", start.x);
        labelTSpan.setAttribute("y", start.y);
        labelTSpan.textContent = data.label;

        const valueTSpan = document.getElementById(this._tooltip.elements.value);
        valueTSpan.setAttribute("x", start.x);
        valueTSpan.setAttribute("y", start.y);
        valueTSpan.textContent = `Size: ${Utils.toHumanReadableSize(data.value)}`;

        const percentageTSpan = document.getElementById(this._tooltip.elements.percentage);
        percentageTSpan.setAttribute("x", start.x);
        percentageTSpan.setAttribute("y", start.y);
        percentageTSpan.textContent = `Percentage: ${Utils.toPercentage(data.value / this._total)}`;

        const detailsTSpan = document.getElementById(this._tooltip.elements.details);
        detailsTSpan.setAttribute("x", start.x);
        detailsTSpan.setAttribute("y", start.y);
        detailsTSpan.textContent = "details" in data ? data.details : "";

        document.getElementById(this._tooltip.elements.root).style.visibility = "visible";
    }

    _hideTooltip() {
        document.getElementById(this._tooltip.elements.root).style.visibility = "hidden";
    }

    draw() {
        const titleGroup = this._drawTitle();

        const chartGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        let offset = 0;
        for (let item of this._data) {
            chartGroup.appendChild(this._drawBar(item, offset));
            offset += item.value / this._total;
        }

        const tooltipGroup = this._drawTooltip();

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        HorizontalStackedBar._setElementStyle(svg, HorizontalStackedBar.Style.SVG);
        svg.setAttribute("width", this._width);
        svg.setAttribute("height", this._height);
        svg.appendChild(titleGroup);
        svg.appendChild(chartGroup);
        svg.appendChild(tooltipGroup);

        document.getElementById(this._container).replaceChildren(svg);
    }
}

HorizontalStackedBar.Style = {
    SVG: {
        background: "white"
    },
    Title: {
        Rect: {
            fill: "white"
        },
        Text: {
            fontSize: "24px",
            dominantBaseline: "middle",
            textAnchor: "start"
        }
    },
    Bar: {
        Rect: (ratio) => {
            const low = { r: 117, g: 168, b: 179 }; // #75a8b3
            const high = { r: 4, g: 73, b: 88 }; // #044958
            const fill = {
                r: low.r + ratio * (high.r - low.r),
                g: low.g + ratio * (high.g - low.g),
                b: low.b + ratio * (high.b - low.b),
            };
    
            return {
                fill: `rgb(${fill.r}, ${fill.g}, ${fill.b})`,
                stroke: "white",
                strokeWidth: "5px"
            };
        },
        Text: {
            fill: "white",
            fontSize: "20px",
            fontWeight: 600,
            dominantBaseline: "middle",
            textAnchor: "middle"
        }
    },
    Tooltip: {
        Container: {
            pointerEvents: "none",
            visibility: "hidden"
        },
        Rect: {
            fill: "black",
            fillOpacity: 0.8
        },
        Text: {
            dominantBaseline: "middle",
            textAnchor: "middle"
        },
        Label: {
            fill: "#fff",
            fontSize: "15px",
            fontWeight: 600
        },
        Content: {
            fill: "#fff",
            fontSize: "13px"
        }
    }
};
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

const mainInitializer = () => {
    const data = window.data;
    document.title = data.name + " - " + document.title;
    document.querySelector("#image-name").innerHTML = data.name;

    const generateWorkerMethodURL = (method) => {
        return URL.createObjectURL(new Blob([`(${method.toString()})()`], { type: "text/javascript" } ));
    };

    const buildOutput = BuildOutput.getInstance();
    buildOutput.setData(data.buildOutput);
    buildOutput.render("build-output-image-details");
    document.getElementById("build-output-download").onclick = function(e) {
        e.preventDefault();
        const buildOutput = BuildOutput.getInstance();
        const text = JSON.stringify(buildOutput.getData(), null, 2);
        Utils.download(`${data.name}-build-output.json`, text);
    };

    const methodBreakdownType = document.querySelector("#method-breakdown-type");

    const renderMethodBasedBreakdown = () => {
        const methodBreakdown = MethodBreakdown.getInstance();
        const type = methodBreakdownType.options[methodBreakdownType.selectedIndex].value;

        methodBreakdown.render(type, "method-breakdown", "package-class-list");
    };

    const methodBreakdownWorker = new Worker(generateWorkerMethodURL(MethodBreakdown.dataWorker));
    methodBreakdownWorker.onmessage = function(e) {
        const methodBreakdown = MethodBreakdown.getInstance();

        methodBreakdown.setCountData(e.data.countData);
        methodBreakdown.setBytecodeSizeData(e.data.bytecodeSizeData);

        renderMethodBasedBreakdown();
    };
    methodBreakdownWorker.postMessage(data);

    methodBreakdownType.onchange = renderMethodBasedBreakdown;

    const heapBreakdown = HeapBreakdown.getInstance();
    heapBreakdown.setData(data.heap);
    heapBreakdown.render("heap-breakdown", "heap-breakdown-total-size");

    if (data.sbom) {
        const sbom = SBOMList.getInstance();
        sbom.setData(data.sbom);
        sbom.render("sbom-list");

        document.getElementById('sbom-download').onclick = function(e) {
            e.preventDefault();
            const sbom = SBOMList.getInstance();
            const text = JSON.stringify(sbom.getData(), null, 2);
            Utils.download(`${data.name}-sbom.json`, text);
        };
    } else {
        document.querySelector("li [data-target=\"#sbom-tab\"]").remove();
        document.querySelector("#sbom-tab").remove();
    }
};

window.addEventListener("load", mainInitializer);
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

class HeapBreakdown {
    constructor() {}

    // class fields are not well supported by Closure: https://github.com/google/closure-compiler/issues/2731

    static getInstance() {
        if (!this._instance) {
            this._instance = new HeapBreakdown();
        }
        return this._instance;
    }

    setData(data) {
        this._data = data;
    }

    render(container, totalSizeElementId) {
        const table = document.getElementById(container);
        table.innerHTML = "";

        const totalSizeElem = document.getElementById(totalSizeElementId);
        totalSizeElem.innerText = Utils.toHumanReadableSize(this._data.total);

        const items = this._data.items.sort((a, b) => b.size - a.size);
        for (let i in items) {
            const size = items[i].size;
            const percentage = size * 100 / this._data.total;
            const html =
                `<tr>
                    <td class="heap-item-name">${items[i].name}</td>
                    <td class="heap-item-size">
                        <meter value="${percentage}" min="0" max="100"></meter>
                        <span>${Utils.toPercentage(size / this._data.total, percentage > 0.1 ? 2 : 3)}</b> (${Utils.toHumanReadableSize(size)})</span>
                    </td>
                </tr>`;

            const template = document.createElement("template");
            template.innerHTML = html;

            table.appendChild(template.content.firstChild);
        }
    };
}
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */
class Sunburst {

    // class fields are not well supported by Closure: https://github.com/google/closure-compiler/issues/2731

    constructor(width, height, data, valueKind, container, updateCallback) {
        this._width = width;
        this._height = height;
        this._data = data;
        this._valueKind = valueKind;
        this._container = container;
        this._updateCallback = updateCallback;

        this._title = {
            start: {
                x: 0,
                y: 0
            },
            width: width,
            height: 0.15 * height
        };
        this._padding = {
            bottom: 0.05 * this._height
        };
        this._chart = {
            start: {
                x: 0,
                y: this._title.height
            },
            width: width,
            height: height - this._title.height - this._padding.bottom,
        };
        this._chart.center = {
            x: this._chart.start.x + this._chart.width / 2,
            y: this._chart.start.y + this._chart.height / 2
        }
        this._chart.maxRadius = Math.min(this._chart.width, this._chart.height) / 2;
        this._tooltip = {
            width: 175,
            height: 75,
            elements: {
                root: `${this._container}-tooltip`,
                container: `${this._container}-tooltip-container`,
                label: `${this._container}-tooltip-label`,
                value: `${this._container}-tooltip-value`,
                percentage: `${this._container}-tooltip-percentage`,
            },
            offset: {
                x: 35,
                y: -35
            }
        };
    }

    static _setElementStyle(element, style) {
        for (const rule in style) {
            element.style[rule] = style[rule];
        }
    }

    _calculateRelativeDepth(data) {
        return data.depth - this._data.depth;
    }

    _calculateRelativeRatio(data) {
        return data.ratio / this._data.ratio;
    }

    _calculateRadius(depth) {
        const maxDepth = Math.min(this._data.height, Sunburst.MaxDepth);
        const r0 = 0.2 * this._chart.maxRadius;
        const dr = ((maxDepth + 1) * r0 - this._chart.maxRadius) / (maxDepth * (maxDepth + 1));

        return r0 * (depth + 1) - (depth * (depth + 1)) * dr;
    }

    _polarToCartesian(radius, angle) {
        angle = angle - Math.PI / 2; // starting angle offset

        return {
            x: this._chart.center.x + (radius * Math.cos(angle)),
            y: this._chart.center.y + (radius * Math.sin(angle))
        };
    }

    _describeArcPath(depth, ratio, offset) {
        const innerRadius = this._calculateRadius(depth - 1);
        const outerRadius = this._calculateRadius(depth);

        const startAngle = offset * 2 * Math.PI;
        const endAngle = ratio < 1 ? startAngle + ratio * 2 * Math.PI : 0.999999 * 2 * Math.PI; // workaround for full circle arcs

        const innerStart = this._polarToCartesian(innerRadius, endAngle);
        const innerEnd = this._polarToCartesian(innerRadius, startAngle);

        const outerStart = this._polarToCartesian(outerRadius, endAngle);
        const outerEnd = this._polarToCartesian(outerRadius, startAngle);

        const largeArcFlag = endAngle - startAngle <= Math.PI ? 0 : 1;

        return [
            `M${innerStart.x},${innerStart.y}`,
            `A${innerRadius},${innerRadius},0,${largeArcFlag},0,${innerEnd.x},${innerEnd.y}`,
            `L${outerEnd.x},${outerEnd.y}`,
            `A${outerRadius},${outerRadius},0,${largeArcFlag},1,${outerStart.x},${outerStart.y}`,
            `Z`
        ].join("");
    }

    _transformArcText(depth, ratio, offset, textLength) {
        const scale = (textLength, textWidth) => {
            const k = 0.1;
            const a = 10;

            return k * textWidth / (textLength + a) < 1 ? k * textWidth / (textLength + a) : 1;
        };
        const rotationAngle = (angle, isVertical) => {
            angle = angle >= Math.PI / 2 && angle <= Math.PI * 3 / 2 ?  angle - Math.PI : angle; // horizontal alignment
            if (isVertical) {
                angle -= Math.PI / 2;
            }

            return angle * 180 / Math.PI;
        };

        const innerRadius = depth > 0 ? this._calculateRadius(depth - 1) : 0;
        const outerRadius = depth > 0 ? this._calculateRadius(depth) : 0;
        const midRadius = (innerRadius + outerRadius) / 2;

        const startAngle = offset * 2 * Math.PI;
        const endAngle = startAngle + ratio * 2 * Math.PI;
        const midAngle = (startAngle + endAngle) / 2;

        const midCenter = this._polarToCartesian(midRadius, midAngle);

        const arcWidth = (endAngle - startAngle) * midRadius;
        const arcHeight = outerRadius - innerRadius;
        const textWidth = Math.max(arcWidth, arcHeight);

        return [
            `translate(${midCenter.x}, ${midCenter.y})`,
            `scale(${textWidth > 0 ? scale(textLength, textWidth) : 1})`,
            `rotate(${rotationAngle(midAngle, arcWidth < arcHeight)})`
        ].join("");
    }

    _calculateArcCenter(depth, ratio, offset) {
        const innerRadius = this._calculateRadius(depth - 1);
        const outerRadius = this._calculateRadius(depth);
        const startAngle = offset * 2 * Math.PI;
        let endAngle = startAngle + ratio * 2 * Math.PI;
        let midAngle = (startAngle + endAngle) / 2;

        let midRadius = (innerRadius + outerRadius) / 2;
        let midCenter = this._polarToCartesian(midRadius, midAngle);

        return midCenter;
    }

    _drawTitle() {
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        Sunburst._setElementStyle(rect, Sunburst.Style.Title.Rect);
        rect.setAttribute("x", this._title.start.x);
        rect.setAttribute("y", this._title.start.y);
        rect.setAttribute("width", this._title.width);
        rect.setAttribute("height", this._title.height);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        Sunburst._setElementStyle(text, Sunburst.Style.Title.Text);
        text.setAttribute("x", this._title.width / 2);
        text.setAttribute("y", this._title.height / 2);

        if (this._data.parent != null) {
            const labelTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
            labelTSpan.textContent = this._data.label;
            text.prepend(labelTSpan);

            let parent = this._data.parent;
            while (parent != null) {
                const parentLinkTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                Sunburst._setElementStyle(parentLinkTSpan, Sunburst.Style.Title.Link);
                parentLinkTSpan.textContent = parent.label;

                const parentData = parent;
                parentLinkTSpan.addEventListener("click", function() {
                    this._data = parentData;
                    this.draw();
                    this._updateCallback(this._data, this._valueKind);
                }.bind(this));

                const separatorTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                separatorTSpan.textContent = "\u2192";

                text.prepend(separatorTSpan);
                text.prepend(parentLinkTSpan);

                parent = parent.parent;
            }
        }

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.appendChild(rect);
        g.appendChild(text);

        return g;
    }

    _drawCircle(data) {
        const relativeDepth = this._calculateRelativeDepth(data); // should always be 0
        const relativeRatio = this._calculateRelativeRatio(data); // should always be 1
        const radius = this._calculateRadius(relativeDepth);

        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        Sunburst._setElementStyle(circle, Sunburst.Style.Arc.Path(1));
        circle.setAttribute("cx", this._chart.center.x);
        circle.setAttribute("cy", this._chart.center.y);
        circle.setAttribute("r", radius);

        const labelTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        labelTSpan.setAttribute("x", 0);
        labelTSpan.setAttribute("y", "-1.5%");
        labelTSpan.textContent = data.label;

        const percentageTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        percentageTSpan.setAttribute("x", 0);
        percentageTSpan.setAttribute("y", "1.5%");
        percentageTSpan.textContent = Utils.toPercentage(relativeRatio, 1);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        Sunburst._setElementStyle(text, Sunburst.Style.Arc.Text(1));
        text.setAttribute("transform", this._transformArcText(relativeDepth, relativeRatio, 0, data.label.length));
        text.appendChild(labelTSpan);
        text.appendChild(percentageTSpan);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.appendChild(circle);
        g.appendChild(text);

        g.addEventListener("mouseenter", function() {
            this._showTooltip(this._chart.center, data);
        }.bind(this));
        g.addEventListener("mouseleave", function() {
            this._hideTooltip();
        }.bind(this));

        if (data.parent != null) {
            g.style.cursor = "pointer";
            g.addEventListener("click", function() {
                this._data = data.parent;
                this.draw();
                this._updateCallback(this._data, this._valueKind);
            }.bind(this));
        } else {
            g.style.cursor = "not-allowed";
        }

        return g;
    }

    _drawArc(data, offset) {
        const relativeDepth = this._calculateRelativeDepth(data);
        const relativeRatio = this._calculateRelativeRatio(data);

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        Sunburst._setElementStyle(path, Sunburst.Style.Arc.Path(relativeRatio));
        path.setAttribute("d", this._describeArcPath(relativeDepth, relativeRatio, offset));

        const labelTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        labelTSpan.setAttribute("x", 0);
        labelTSpan.setAttribute("y", "-1.5%");
        labelTSpan.textContent = data.label;

        const percentageTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        percentageTSpan.setAttribute("x", 0);
        percentageTSpan.setAttribute("y", "1.5%");
        percentageTSpan.textContent = Utils.toPercentage(relativeRatio, 1);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        Sunburst._setElementStyle(text, Sunburst.Style.Arc.Text(relativeRatio));
        text.setAttribute("transform", this._transformArcText(relativeDepth, relativeRatio, offset, data.label.length));
        text.appendChild(labelTSpan);
        text.appendChild(percentageTSpan);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.appendChild(path);
        g.appendChild(text);

        g.addEventListener("mouseenter", function() {
            this._showTooltip(this._calculateArcCenter(relativeDepth, relativeRatio, offset), data);
        }.bind(this));
        g.addEventListener("mouseleave", function() {
            this._hideTooltip();
        }.bind(this));

        if (data.children.length > 0) {
            g.style.cursor = "pointer";
            g.addEventListener("click", function() {
                this._data = data;
                this.draw();
                this._updateCallback(this._data, this._valueKind);
            }.bind(this));
        } else {
            g.style.cursor = "not-allowed";
            g.style.opacity = 0.6;
        }

        return g;
    }

    _drawTooltip() {
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        Sunburst._setElementStyle(rect, Sunburst.Style.Tooltip.Rect);
        rect.setAttribute("id", this._tooltip.elements.container);
        rect.setAttribute("height", this._tooltip.height);

        const labelTspan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        Sunburst._setElementStyle(labelTspan, Sunburst.Style.Tooltip.Label);
        labelTspan.setAttribute("id", this._tooltip.elements.label);
        labelTspan.setAttribute("dy", 0.2 * this._tooltip.height);

        const valueTspan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        Sunburst._setElementStyle(valueTspan, Sunburst.Style.Tooltip.Content);
        valueTspan.setAttribute("id", this._tooltip.elements.value);
        valueTspan.setAttribute("dy", 0.5 * this._tooltip.height);

        const percentageTSpan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        Sunburst._setElementStyle(percentageTSpan, Sunburst.Style.Tooltip.Content);
        percentageTSpan.setAttribute("id", this._tooltip.elements.percentage);
        percentageTSpan.setAttribute("dy", 0.8 * this._tooltip.height);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        Sunburst._setElementStyle(text, Sunburst.Style.Tooltip.Text);
        text.appendChild(labelTspan);
        text.appendChild(valueTspan);
        text.appendChild(percentageTSpan);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        Sunburst._setElementStyle(g, Sunburst.Style.Tooltip.Container);
        g.setAttribute("id", this._tooltip.elements.root);
        g.appendChild(rect);
        g.appendChild(text);

        return g;
    }

    _showTooltip(center, data) {
        const start = {
            x: center.x + this._tooltip.offset.x,
            y: center.y + this._tooltip.offset.y,
        }
        const width = data.label.length > 15 ? data.label.length * 10 : this._tooltip.width; // Workaround for very long package names

        const container = document.getElementById(this._tooltip.elements.container);
        container.setAttribute("width", width);
        container.setAttribute("x", start.x);
        container.setAttribute("y", start.y);

        const labelTSpan = document.getElementById(this._tooltip.elements.label);
        labelTSpan.setAttribute("x", start.x);
        labelTSpan.setAttribute("y", start.y);
        labelTSpan.setAttribute("dx", width / 2);
        labelTSpan.textContent = data.label;

        const valueTSpan = document.getElementById(this._tooltip.elements.value);
        valueTSpan.setAttribute("x", start.x);
        valueTSpan.setAttribute("y", start.y);
        valueTSpan.setAttribute("dx", width / 2);
        let valueText;
        switch (this._valueKind) {
            case Sunburst.ValueKind.count: {
                valueText = `# of methods: ${data.value}`;
                break;
            }
            case Sunburst.ValueKind.bytecodeSize: {
                valueText = `Bytecode size: ${Utils.toHumanReadableSize(data.value)}`;
                break;
            }
        }
        valueTSpan.textContent = valueText;

        const percentageTSpan = document.getElementById(this._tooltip.elements.percentage);
        percentageTSpan.setAttribute("x", start.x);
        percentageTSpan.setAttribute("y", start.y);
        percentageTSpan.setAttribute("dx", width / 2);
        percentageTSpan.textContent = `Percentage: ${Utils.toPercentage(this._calculateRelativeRatio(data))}`;

        document.getElementById(this._tooltip.elements.root).style.visibility = "visible";
    }

    _hideTooltip() {
        document.getElementById(this._tooltip.elements.root).style.visibility = "hidden";
    }

    draw() {
        const titleGroup = this._drawTitle();

        const chartGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        const queue = [];
        queue.push({
            data: [this._data],
            offset: 0
        });
        while (queue.length > 0) {
            const children = queue.shift();
            if (this._calculateRelativeDepth(children.data[0]) == 0) {
                const rootData = children.data[0];
                chartGroup.appendChild(this._drawCircle(rootData));
                if (rootData.children.length > 0) {
                    queue.push({
                        data: rootData.children,
                        offset: 0
                    });
                }
            } else {
                let offset = children.offset;
                const sortedChildrenData = children.data.sort((a, b) => b.ratio - a.ratio);
                for (const childData of sortedChildrenData) {
                    chartGroup.appendChild(this._drawArc(childData, offset));
                    if (childData.children.length > 0 && this._calculateRelativeDepth(childData) < Sunburst.MaxDepth) {
                        queue.push({
                            data: childData.children,
                            offset: offset
                        });
                    }
                    offset += this._calculateRelativeRatio(childData);
                }
            }
        }

        const tooltipGroup = this._drawTooltip();

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        Sunburst._setElementStyle(svg, Sunburst.Style.SVG);
        svg.setAttribute("width", this._width);
        svg.setAttribute("height", this._height);
        svg.appendChild(titleGroup);
        svg.appendChild(chartGroup);
        svg.appendChild(tooltipGroup);

        document.getElementById(this._container).replaceChildren(svg);
    }
}

Sunburst.Style = {
    SVG: {
        background: "white"
    },
    Title: {
        Rect: {
            fill: "white"
        },
        Text: {
            fontSize: "20px",
            fontWeight: "600",
            dominantBaseline: "middle",
            textAnchor: "middle"
        },
        Link: {
            fill: "var(--color-graalvm-dark-green)",
            cursor: "pointer"
        }
    },
    Arc: {
        Path: (ratio) => {
            const low = { r: 117, g: 168, b: 179 }; // #75a8b3
            const high = { r: 4, g: 73, b: 88 }; // #044958
            const fill = {
                r: low.r + ratio * (high.r - low.r),
                g: low.g + ratio * (high.g - low.g),
                b: low.b + ratio * (high.b - low.b),
            };
    
            return {
                fill: `rgb(${fill.r}, ${fill.g}, ${fill.b})`,
                stroke: "white"
            };
        },
        Text: (ratio) => {
            return {
                fill: "white",
                fontSize: ratio > 0.003 ? "14px" : 0,
                fontWeight: 600,
                dominantBaseline: "middle",
                textAnchor: "middle"
            };
        }
    },
    Tooltip: {
        Container: {
            pointerEvents: "none",
            visibility: "hidden"
        },
        Rect: {
            fill: "black",
            fillOpacity: 0.8
        },
        Text: {
            dominantBaseline: "middle",
            textAnchor: "middle"
        },
        Label: {
            fill: "#fff",
            fontSize: "15px",
            fontWeight: 600
        },
        Content: {
            fill: "#fff",
            fontSize: "13px"
        }
    }
};

Sunburst.MaxDepth = 5;

Sunburst.ValueKind = {
    count: "count",
    bytecodeSize: "bytecodeSize"
};
</script>
<script>
/*
 * Copyright (c) 2023, 2023, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */

class Utils {
    static printIfExists(data, trueMessage = data, falseMessage = "-") {
        return data >= 0 ? trueMessage : falseMessage;
    }

    static toPercentage(ratio, precision = 3) {
        return `${(ratio * 100).toFixed(precision)}%`;
    }

    static toHumanReadableSize(size) {
        const exponent = size == 0 ? 0 : Math.floor(Math.log(size) / Math.log(1024));

        return (size / Math.pow(1024, exponent)).toFixed(2) * 1 + " " + ["B", "kB", "MB", "GB", "TB"][exponent];
    }

    /**
     * Download to the user's machine a file named `filename` with the given `text` as content.
     */
    static download(filename, text) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();
        document.body.removeChild(element);
    }
}
</script>
<script>
var data={"name":"name-crawler","buildOutput":{"resource_usage":{"memory":{"system_total":8589934592,"peak_rss_bytes":1541472256},"garbage_collection":{"count":55,"total_secs":2.329},"cpu":{"load":5.176955452818693,"total_cores":8},"total_secs":27.226032},"general_info":{"c_compiler":"cc (apple, arm64, 14.0.3)","name":"name-crawler","java_version":"20.0.2+9","garbage_collector":"Serial GC","graal_compiler":{"pgo":["user-provided"],"march":"native","optimization_level":"2"},"vendor_version":"Oracle GraalVM 20.0.2+9.1","graalvm_version":"Oracle GraalVM 20.0.2+9.1"},"analysis_results":{"types":{"total":9667,"reflection":2488,"jni":66,"reachable":8524},"methods":{"total":72376,"reflection":3307,"jni":60,"reachable":46028},"classes":{"total":9667,"reflection":2488,"jni":66,"reachable":8524},"fields":{"total":21069,"reflection":517,"jni":72,"reachable":11917}}},"types":[],"methods":[],"heap":{"total":0,"items":[]},};
</script>
    </body>
</html>
