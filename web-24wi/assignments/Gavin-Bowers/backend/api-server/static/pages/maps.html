<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="map">
    </div>

    <script src="https://unpkg.com/topojson@3"></script>
    <script defer type="module">
        import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

        function getSVGNode(us, cities) {
            const width = 975;
            const height = 610;

            const svg = d3.create("svg")
                .attr("viewBox", [0,0, width, height])
                .attr("width", width)
                .attr("height", height)
                .attr("style", "max-width: 100%; height: auto;");

            const path = d3.geoPath();
            let projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305])

            //Nation outline
            svg.append("path")
                .datum(topojson.feature(us, us.objects.nation))
                .attr("fill", "#ddd")
                .attr("d", path);

            //States' outlines
            svg.append("g")
                .attr("fill", "#444")
                .attr("stroke", "#fff")
                .attr("stroke-linejoin", "round")
                .attr("stroke-linecap", "round")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .join("path")
                .attr("d", path);
            
            const g = svg.append("g")
                .attr("text-anchor", "middle")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10");
            
            cities.forEach(({ city, state, latitude, longitude, population }) => {
                const coords = projection([longitude, latitude]);
                if (coords) {
                    const node = g.append("g").attr("transform", `translate(${coords})`);
                    let size = 0;
                    size = Math.log(population)/10;
                    node.append("circle")
                        .attr("r", size)
                        .attr("fill", "#ddd");
                    // node.append("text")
                    //     .attr("y", "-6")
                    //     .text(city);
                }
            });
            return svg.node();
        }
        function normalize(val, max, min) {
            return (val - min) / (max - min);
        }

        const response = await fetch("https://indira.arcology.builders/us.json");
        const us = await response.json();
        const response2 = await fetch("https://indira.arcology.builders/uscities.json");
        const cities = await response2.json();
        const svgNode = getSVGNode(us, cities);
        const mapDiv = document.getElementById("map");
        mapDiv.appendChild(svgNode);
    </script>
</body>
</html>
